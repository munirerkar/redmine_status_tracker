<h2>üìä <%= @project.name %> - Son ƒ∞≈ü Kayƒ±tlarƒ±</h2>

<% content_for :header_tags do %>
    <%= javascript_include_tag 'status_tracker', :plugin => 'redmine_status_tracker' %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <%= stylesheet_link_tag 'status_tracker', :plugin => 'redmine_status_tracker' %>
<% end %>

<div class="table-scroll-wrapper">
  <table class="list issues">
    <thead>
      <tr>
      <th>
        <%= link_to '# ID', { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'id', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>Konu</th>
      <th>
        <%= link_to 'Kategori', { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'category_id', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>
        <%= link_to 'Atanan Ki≈üi', { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'assigned_to_id', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>
        <%= link_to '≈ûu Anki Durum', { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'status_id', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>
        <%= link_to '‚è±Ô∏è S√ºre Analizi', { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'updated_on', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>
        <%= link_to 'Olu≈üturulma Tarihi', { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'created_on', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
    </tr>
  </thead>
  <tbody>
    <% @issues.each_with_index do |issue, index| %>
    <% 
       # √ñNCEKƒ∞ ve SONRAKƒ∞ ƒ∞≈üi Bulma Mantƒ±ƒüƒ±
       prev_issue = index > 0 ? @issues[index - 1] : nil
       next_issue = index < @issues.length - 1 ? @issues[index + 1] : nil
    %>
    <tr class="<%= cycle('odd', 'even') %>">
      <td><%= link_to issue.id, issue_path(issue) %></td>
      <td><%= link_to issue.subject, issue_path(issue) %></td>
      <td><%= issue.category ? issue.category.name : '-' %></td>
      <td><%= issue.assigned_to ? issue.assigned_to.name : '-' %></td>
      <td><%= issue.status.name %></td>
      <td>
        <% 
           history_list = calculate_time_in_statuses(issue) 
           current_state = history_list.last
           previous_states = history_list[0...-1] 
        %>

        <div style="font-weight:bold; color:#28a745;">
           <%= current_state[:status] %>: <%= format_duration(current_state[:duration]) %>
        </div>
        <div style="font-size:0.85em; color:#666;">(Devam Ediyor...)</div>

        <% if previous_states.any? %>
          <div style="margin-top:5px;">
            <a href="javascript:void(0)" onclick="openHistoryModal('modal-<%= issue.id %>')" style="font-size:0.9em; text-decoration:underline; color:#1a73e8;">
              üîç Detaylar
            </a>
          </div>

          <div id="modal-<%= issue.id %>" class="custom-modal">
            <div class="custom-modal-content">
              
              <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #333;">
                  <span style="color: #666;">#<%= issue.id %></span> <%= issue.subject %>
                </h3>
                <span class="custom-close" onclick="closeHistoryModal('modal-<%= issue.id %>')">&times;</span>
              </div>
              
              <table class="list" style="width:100%; margin-bottom: 20px;">
                <thead>
                  <tr>
                    <th>Durum</th>
                    <th>Ge√ßen S√ºre</th>
                    <th>Deƒüi≈ütiren Ki≈üi</th>
                  </tr>
                </thead>
                <tbody>
                  <% previous_states.each do |item| %>
                    <tr>
                      <td style="font-weight:bold;"><%= item[:status] %></td>
                      <td><%= format_duration(item[:duration]) %></td>
                      <td><span style="font-style:italic; color:#666;"><%= item[:author] %></span></td>
                    </tr>
                  <% end %>
                   <tr style="background-color:#e8f5e9;">
                      <td style="font-weight:bold;"><%= current_state[:status] %> (G√ºncel)</td>
                      <td><%= format_duration(current_state[:duration]) %></td>
                      <td>-</td>
                    </tr>
                </tbody>
              </table>

              <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 15px;">
                
                <div>
                  <% if prev_issue %>
                    <button onclick="closeHistoryModal('modal-<%= issue.id %>'); openHistoryModal('modal-<%= prev_issue.id %>')" style="cursor: pointer;">
                      &laquo; √ñnceki Konu
                    </button>
                    <div style="font-size: 10px; color: #888; margin-top: 2px; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                       #<%= prev_issue.id %> - <%= prev_issue.subject %>
                    </div>
                  <% else %>
                    <button disabled style="opacity: 0.5; cursor: not-allowed;">&laquo; √ñnceki Yok</button>
                  <% end %>
                </div>

                <div style="text-align: right;">
                  <% if next_issue %>
                    <button onclick="closeHistoryModal('modal-<%= issue.id %>'); openHistoryModal('modal-<%= next_issue.id %>')" style="cursor: pointer;">
                      Sonraki Konu &raquo;
                    </button>
                    <div style="font-size: 10px; color: #888; margin-top: 2px; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                       #<%= next_issue.id %> - <%= next_issue.subject %>
                    </div>
                  <% else %>
                    <button disabled style="opacity: 0.5; cursor: not-allowed;">Sonraki Yok &raquo;</button>
                  <% end %>
                </div>

              </div>

            </div>
          </div>
        <% end %>
      </td>
        <td><%= format_time(issue.created_on) %></td>
      </tr>
      <% end %>
    </tbody>
  </table>
</div>
<div class="pagination">
  <%= pagination_links_full @issue_pages, @issue_count %>
</div>

<% if @issues.empty? %>
  <p class="nodata">Hen√ºz hi√ß i≈ü kaydƒ± yok.</p>
<% end %>

<hr />

<h3>üìë Kategori ve Kullanƒ±cƒ± √ñzeti</h3>
<table class="list">
  <thead>
    <tr>
      <th>
        <%= link_to 'Kategori', { 
            :controller => 'status_tracker', 
            :action => 'index', 
            :project_id => @project,
            # Ana tablonun sƒ±ralamasƒ±nƒ± korumak i√ßin mevcut parametreleri ekliyoruz
            :sort => params[:sort], 
            :direction => params[:direction],
            # √ñzet tablosu i√ßin YENƒ∞ parametreler
            :summary_sort => 'category', 
            :summary_dir => (params[:summary_dir] == 'asc' ? 'desc' : 'asc') 
        } %>
      </th>

      <th>
        <%= link_to 'Kullanƒ±cƒ±', { 
            :controller => 'status_tracker', 
            :action => 'index', 
            :project_id => @project,
            :sort => params[:sort], 
            :direction => params[:direction],
            :summary_sort => 'user', 
            :summary_dir => (params[:summary_dir] == 'asc' ? 'desc' : 'asc') 
        } %>
      </th>

      <th>
        <%= link_to 'Toplam ƒ∞≈ü Sayƒ±sƒ±', { 
            :controller => 'status_tracker', 
            :action => 'index', 
            :project_id => @project,
            :sort => params[:sort], 
            :direction => params[:direction],
            :summary_sort => 'count', 
            :summary_dir => (params[:summary_dir] == 'asc' ? 'desc' : 'asc') 
        } %>
      </th>
    </tr>
  </thead>
  <tbody>
    <% @summary_table.each do |row| %>
    <tr class="<%= cycle('odd', 'even') %>">
      <td><%= row[:category_name] %></td>
      <td><%= row[:user_name] %></td>
      <td style="font-weight:bold; text-align:center;"><%= row[:count] %></td>
    </tr>
    <% end %>
    
    <tr style="background-color: #f5f5f5; font-weight: bold;">
      <td colspan="2" style="text-align: right;">GENEL TOPLAM:</td>
      <td style="text-align: center;"><%= @issue_count %></td>
    </tr>
  </tbody>
</table>

<hr />

<div style="width: 500px; margin: 20px auto; text-align: center;">
  <h3>üìà ƒ∞≈ü Durum Daƒüƒ±lƒ±mƒ±</h3>
  <canvas id="statusChart" 
          data-labels="<%= @chart_labels.to_json %>" 
          data-values="<%= @chart_data.to_json %>">
  </canvas>
</div>

