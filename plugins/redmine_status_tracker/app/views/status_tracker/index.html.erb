<% content_for :header_tags do %>
    <%= javascript_include_tag 'status_tracker', :plugin => 'redmine_status_tracker' %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <%= stylesheet_link_tag 'status_tracker', :plugin => 'redmine_status_tracker' %>
<% end %>

<h2>ðŸ“Š <%= @project.name%> <%=l(:label_latest_issues)%></h2>

<fieldset style="border: 1px solid #e0e0e0; padding: 10px; margin-bottom: 15px; background: #f9f9f9; border-radius: 5px;">
  <legend style="font-weight: bold; color: #555;"><%=l(:label_filter_title)%></legend>
  
  <form action="" method="get" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
    <%= hidden_field_tag 'project_id', @project.identifier %>
    
    <div>
      <label for="status_id"><%=l(:label_status)%>:</label>
      <%= select_tag 'status_id', 
          options_from_collection_for_select(IssueStatus.all, 'id', 'name', params[:status_id]), 
          prompt: l(:label_all), 
          style: "border: 1px solid #ccc; border-radius: 3px;" %>
    </div>

    <div>
      <label for="assigned_to_id"><%=l(:label_assigned_to)%>:</label>
      <%= select_tag 'assigned_to_id', 
          options_from_collection_for_select(@project.members.map(&:user), 'id', 'name', params[:assigned_to_id]), 
          prompt: l(:label_all), 
          style: "border: 1px solid #ccc; border-radius: 3px;" %>
    </div>

    <div>
      <label for="category_id"><%=l(:label_category)%>:</label>
      <%= select_tag 'category_id', 
          options_from_collection_for_select(@project.issue_categories, 'id', 'name', params[:category_id]), 
          prompt: l(:label_all), 
          style: "border: 1px solid #ccc; border-radius: 3px;" %>
    </div>

    <div>
      <button type="submit" class="icon icon-checked"><%=l(:label_apply)%></button>
      <a href="?" class="icon icon-reload"><%=l(:label_clear)%></a>
    </div>
  </form>
</fieldset>

<div class="table-scroll-wrapper">
  <table class="list issues">
    <thead>
      <tr>
      <th>
        <%= link_to l(:label_issue_id), { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'id', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th><%=l(:label_subject)%></th>
      <th>
        <%= link_to l(:label_category), { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'category_id', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>
        <%= link_to l(:label_assigned_to), { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'assigned_to_id', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>
        <%= link_to l(:label_status), { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'status_id', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>
        <%= link_to l(:label_status_tracker), { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'updated_on', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
      <th>
        <%= link_to l(:label_created_date), { :controller => 'status_tracker', :action => 'index', :project_id => @project, :sort => 'created_on', :direction => (params[:direction] == 'asc' ? 'desc' : 'asc') } %>
      </th>
    </tr>
  </thead>
  <tbody>
    <% @issues.each_with_index do |issue, index| %>
    <% 
       # Ã–NCEKÄ° ve SONRAKÄ° Ä°ÅŸi Bulma MantÄ±ÄŸÄ±
       prev_issue = index > 0 ? @issues[index - 1] : nil
       next_issue = index < @issues.length - 1 ? @issues[index + 1] : nil
    %>
    <tr class="<%= cycle('odd', 'even') %>">
      <td><%= link_to issue.id, issue_path(issue) %></td>
      <td><%= link_to issue.subject, issue_path(issue) %></td>
      <td><%= issue.category ? issue.category.name : '-' %></td>
      <td><%= issue.assigned_to ? issue.assigned_to.name : '-' %></td>
      <td><%= issue.status.name %></td>
      <td>
        <% 
           history_list = calculate_time_in_statuses(issue) 
           current_state = history_list.last
           previous_states = history_list[0...-1] 
        %>

        <div style="font-weight:bold; color:#28a745;">
           <%= current_state[:status] %>: <%= format_duration(current_state[:duration]) %>
        </div>
        <div style="font-size:0.85em; color:#666;"><%=l(:label_continuing)%></div>

        <% if previous_states.any? %>
          <% 
             chart_labels = history_list.map { |h| h[:status] }
             chart_data = history_list.map { |h| (h[:duration] / 3600.0).round(2) } 
          %>
          <div style="margin-top:5px;">
            <a href="javascript:void(0)" 
               onclick="openHistoryModal('modal-<%= issue.id %>', 'chart-<%= issue.id %>', <%= chart_labels.to_json %>, <%= chart_data.to_json %>, '<%= l(:label_elapsed_time) %>', '<%= l(:label_hour) %>')"
               style="font-size:0.9em; text-decoration:underline; color:#1a73e8;">
              <%=l(:label_details)%>
            </a>
          </div>

          <div id="modal-<%= issue.id %>" class="custom-modal">
            <div class="custom-modal-content">
              
              <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #333;">
                  <span style="color: #666;">#<%= issue.id %></span> <%= issue.subject %>
                </h3>
                <span class="custom-close" onclick="closeHistoryModal('modal-<%= issue.id %>')">&times;</span>
              </div>

              <div style="height: 200px; margin-bottom: 20px;">
                <canvas id="chart-<%= issue.id %>"></canvas>
              </div>

              <table class="list" style="width:100%; margin-bottom: 20px;">
                <thead>
                  <tr>
                    <th><%=l(:label_status)%></th>
                    <th><%=l(:label_elapsed_time)%></th>
                    <th><%=l(:label_assigned_to)%></th>
                  </tr>
                </thead>
                <tbody>
                  <% previous_states.each do |item| %>
                    <tr>
                      <td style="font-weight:bold;"><%= item[:status] %></td>
                      <td><%= format_duration(item[:duration]) %></td>
                      <td><span style="font-style:italic; color:#666;"><%= item[:author] %></span></td>
                    </tr>
                  <% end %>
                   <tr style="background-color:#e8f5e9;">
                      <td style="font-weight:bold;"><%= current_state[:status] %> (GÃ¼ncel)</td>
                      <td><%= format_duration(current_state[:duration]) %></td>
                      <td>-</td>
                    </tr>
                </tbody>
              </table>

              <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 15px;">
                
                <div>
                  <% if prev_issue %>
                    <% 
                       p_hist = calculate_time_in_statuses(prev_issue)
                       p_labels = p_hist.map { |h| h[:status] }
                       p_data = p_hist.map { |h| (h[:duration] / 3600.0).round(2) }
                    %>
                    <button onclick="closeHistoryModal('modal-<%= issue.id %>'); openHistoryModal('modal-<%= prev_issue.id %>', 'chart-<%= prev_issue.id %>', <%= p_labels.to_json %>, <%= p_data.to_json %>, '<%= l(:label_elapsed_time) %>', '<%= l(:label_hour) %>')" style="cursor: pointer;">
                      &laquo; <%=l(:label_prev_issue)%>
                    </button>
                    <div style="font-size: 10px; color: #888; margin-top: 2px; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                       #<%= prev_issue.id %> - <%= prev_issue.subject %>
                    </div>
                  <% else %>
                    <button disabled style="opacity: 0.5; cursor: not-allowed;">&laquo; <%=l(:label_prev_issue)%></button>
                  <% end %>
                </div>

                <div style="text-align: right;">
                  <% if next_issue %>
                    <% 
                       n_hist = calculate_time_in_statuses(next_issue)
                       n_labels = n_hist.map { |h| h[:status] }
                       n_data = n_hist.map { |h| (h[:duration] / 3600.0).round(2) }
                    %>
                    <button onclick="closeHistoryModal('modal-<%= issue.id %>'); openHistoryModal('modal-<%= next_issue.id %>', 'chart-<%= next_issue.id %>', <%= n_labels.to_json %>, <%= n_data.to_json %>, '<%= l(:label_elapsed_time) %>', '<%= l(:label_hour) %>')" style="cursor: pointer;">
                      <%=l(:label_next_issue)%> &raquo;
                    </button>
                    <div style="font-size: 10px; color: #888; margin-top: 2px; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                       #<%= next_issue.id %> - <%= next_issue.subject %>
                    </div>
                  <% else %>
                    <button disabled style="opacity: 0.5; cursor: not-allowed;"><%=l(:label_next_issue)%> &raquo;</button>
                  <% end %>
                </div>

              </div>

            </div>
          </div>
        <% end %>
      </td>
        <td><%= format_time(issue.created_on) %></td>
      </tr>
      <% end %>
    </tbody>
  </table>
</div>
<div class="pagination">
  <%= pagination_links_full @issue_pages, @issue_count %>
</div>

<% if @issues.empty? %>
  <p class="nodata"><%=l(:msg_no_data)%></p>
<% end %>

<hr />

<h3>ðŸ“‘ <%= l(:label_category_user_summary) %></h3>

<table class="list">
  <thead>
    <tr>
      <th>
        <%= link_to l(:label_category), { 
            :controller => 'status_tracker', 
            :action => 'index', 
            :project_id => @project,
            :sort => params[:sort], 
            :direction => params[:direction],
            :summary_sort => 'category', 
            :summary_dir => (params[:summary_dir] == 'asc' ? 'desc' : 'asc') 
        } %>
      </th>

      <th>
        <%= link_to l(:label_user), { 
            :controller => 'status_tracker', 
            :action => 'index', 
            :project_id => @project,
            :sort => params[:sort], 
            :direction => params[:direction],
            :summary_sort => 'user', 
            :summary_dir => (params[:summary_dir] == 'asc' ? 'desc' : 'asc') 
        } %>
      </th>

      <th>
        <%= link_to l(:label_total_issue_count), { 
            :controller => 'status_tracker', 
            :action => 'index', 
            :project_id => @project,
            :sort => params[:sort], 
            :direction => params[:direction],
            :summary_sort => 'count', 
            :summary_dir => (params[:summary_dir] == 'asc' ? 'desc' : 'asc') 
        } %>
      </th>
    </tr>
  </thead>
  <tbody>
    <% @summary_table.each do |row| %>
    <tr class="<%= cycle('odd', 'even') %>">
      <td><%= row[:category_name] %></td>
      <td><%= row[:user_name] %></td>
      <td style="font-weight:bold; text-align:center;"><%= row[:count] %></td>
    </tr>
    <% end %>
    
    <tr style="background-color: #f5f5f5; font-weight: bold;">
      <td colspan="2" style="text-align: right;"><%= l(:label_grand_total) %>:</td>
      <td style="text-align: center;"><%= @issue_count %></td>
    </tr>
  </tbody>
</table>

<hr />

<h3>ðŸ“Š <%= l(:label_project_analysis_panel) %></h3>

<div style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px; margin-bottom: 50px;">

  <div style="flex: 1; min-width: 300px; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fafafa;">
    <h4 style="text-align:center; margin-bottom:15px;"><%= l(:label_chart_status) %></h4>
    
    <div style="position: relative; height: 500px; width: 100%;">
      <canvas id="statusChart"
              data-labels='<%= @status_names.to_json %>'
              data-values='<%= @status_values.to_json %>'>
      </canvas>
    </div>
  </div>

  <div style="flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 20px;">
    
    <div style="flex: 1; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fafafa;">
      <h4 style="text-align:center; margin-bottom:10px;"><%= l(:label_chart_category) %></h4>
      <div style="position: relative; height: 220px; width: 100%;">
        <canvas id="categoryChart"
          data-labels='<%= @category_chart_data.map{|i| i[:name]}.to_json %>'
          data-values='<%= @category_chart_data.map{|i| i[:count]}.to_json %>'>
        </canvas>
      </div>
    </div>

    <div style="flex: 1; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fafafa;">
      <h4 style="text-align:center; margin-bottom:10px;"><%= l(:label_chart_user_load) %></h4>
      <div style="position: relative; height: 220px; width: 100%;">
        <canvas id="userChart"
          data-labels='<%= @user_chart_data.map{|i| i[:name]}.to_json %>'
          data-values='<%= @user_chart_data.map{|i| i[:count]}.to_json %>'>
        </canvas>
      </div>
    </div>

  </div>
</div>